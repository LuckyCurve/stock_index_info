# 7-Year Average P/E Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Display 7-year average P/E ratio at the top of stock query results, using Alpha Vantage for EPS data (cached in SQLite) and yfinance for current price.

**Architecture:** New `alpha_vantage.py` module fetches annual EPS data from Alpha Vantage EARNINGS API. EPS data cached in SQLite `earnings` table. Cache invalidation triggered when SEC filing date is newer than cached data. `yfinance` provides real-time stock price. P/E calculation: current_price / avg(7_years_eps).

**Tech Stack:** Alpha Vantage API, yfinance, SQLite, curl_cffi

---

## Task 1: Add yfinance Dependency

**Files:**
- Modify: `pyproject.toml:7-13`

**Step 1: Add yfinance to dependencies**

Edit `pyproject.toml` dependencies section:

```toml
dependencies = [
    "curl_cffi>=0.7.0",
    "beautifulsoup4>=4.12.0",
    "lxml>=5.0.0",
    "pandas>=2.2.0",
    "python-telegram-bot[job-queue]>=21.0",
    "yfinance>=0.2.0",
]
```

**Step 2: Sync dependencies**

Run: `uv sync`
Expected: yfinance installed successfully

**Step 3: Commit**

```bash
git add pyproject.toml uv.lock
git commit -m "deps: add yfinance for real-time stock prices"
```

---

## Task 2: Add EPS Data Models

**Files:**
- Modify: `src/stock_index_info/models.py`
- Test: `tests/test_models.py`

**Step 1: Write the failing test**

Add to `tests/test_models.py`:

```python
def test_earnings_record_creation():
    """Test creating an EarningsRecord."""
    from stock_index_info.models import EarningsRecord

    record = EarningsRecord(
        ticker="AAPL",
        fiscal_year=2024,
        eps=6.42,
    )
    assert record.ticker == "AAPL"
    assert record.fiscal_year == 2024
    assert record.eps == 6.42


def test_cached_earnings_creation():
    """Test creating a CachedEarnings with multiple years."""
    from stock_index_info.models import CachedEarnings, EarningsRecord

    records = [
        EarningsRecord(ticker="AAPL", fiscal_year=2024, eps=6.42),
        EarningsRecord(ticker="AAPL", fiscal_year=2023, eps=6.16),
    ]
    cached = CachedEarnings(
        ticker="AAPL",
        last_updated="2025-01-15",
        annual_eps=records,
    )
    assert cached.ticker == "AAPL"
    assert len(cached.annual_eps) == 2
    assert cached.last_updated == "2025-01-15"
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_models.py::test_earnings_record_creation -v`
Expected: FAIL with "cannot import name 'EarningsRecord'"

**Step 3: Write minimal implementation**

Add to `src/stock_index_info/models.py`:

```python
@dataclass
class EarningsRecord:
    """Annual EPS record for a stock."""

    ticker: str
    fiscal_year: int
    eps: float


@dataclass
class CachedEarnings:
    """Cached earnings data for a stock."""

    ticker: str
    last_updated: str  # ISO format date
    annual_eps: list[EarningsRecord]
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_models.py::test_earnings_record_creation tests/test_models.py::test_cached_earnings_creation -v`
Expected: PASS

**Step 5: Run all tests and type check**

Run: `uv run pytest -v && uv run mypy src/`
Expected: All tests pass, no type errors

**Step 6: Commit**

```bash
git add src/stock_index_info/models.py tests/test_models.py
git commit -m "feat(models): add EarningsRecord and CachedEarnings dataclasses"
```

---

## Task 3: Add ALPHA_VANTAGE_API_KEY to Config

**Files:**
- Modify: `src/stock_index_info/config.py`

**Step 1: Add optional API key config**

Add to `src/stock_index_info/config.py` after line 24:

```python
# Alpha Vantage API key (optional - P/E feature disabled if not set)
ALPHA_VANTAGE_API_KEY: Optional[str] = os.environ.get("ALPHA_VANTAGE_API_KEY") or None
```

Also add `Optional` to imports at top:

```python
from typing import Optional
```

**Step 2: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 3: Commit**

```bash
git add src/stock_index_info/config.py
git commit -m "feat(config): add optional ALPHA_VANTAGE_API_KEY setting"
```

---

## Task 4: Add Earnings Cache Table to Database

**Files:**
- Modify: `src/stock_index_info/db.py`
- Test: `tests/test_db.py`

**Step 1: Write the failing test**

Add to `tests/test_db.py`:

```python
def test_save_and_get_earnings(db_connection):
    """Test saving and retrieving earnings data."""
    from stock_index_info.db import save_earnings, get_cached_earnings
    from stock_index_info.models import EarningsRecord

    records = [
        EarningsRecord(ticker="AAPL", fiscal_year=2024, eps=6.42),
        EarningsRecord(ticker="AAPL", fiscal_year=2023, eps=6.16),
        EarningsRecord(ticker="AAPL", fiscal_year=2022, eps=6.11),
    ]
    save_earnings(db_connection, "AAPL", records, "2025-01-15")

    cached = get_cached_earnings(db_connection, "AAPL")
    assert cached is not None
    assert cached.ticker == "AAPL"
    assert cached.last_updated == "2025-01-15"
    assert len(cached.annual_eps) == 3
    assert cached.annual_eps[0].fiscal_year == 2024
    assert cached.annual_eps[0].eps == 6.42


def test_get_cached_earnings_not_found(db_connection):
    """Test getting earnings for non-existent ticker returns None."""
    from stock_index_info.db import get_cached_earnings

    cached = get_cached_earnings(db_connection, "NOTFOUND")
    assert cached is None


def test_save_earnings_replaces_old_data(db_connection):
    """Test that saving earnings replaces existing data for ticker."""
    from stock_index_info.db import save_earnings, get_cached_earnings
    from stock_index_info.models import EarningsRecord

    # Save initial data
    old_records = [EarningsRecord(ticker="AAPL", fiscal_year=2023, eps=6.16)]
    save_earnings(db_connection, "AAPL", old_records, "2024-01-01")

    # Save new data
    new_records = [
        EarningsRecord(ticker="AAPL", fiscal_year=2024, eps=6.42),
        EarningsRecord(ticker="AAPL", fiscal_year=2023, eps=6.16),
    ]
    save_earnings(db_connection, "AAPL", new_records, "2025-01-15")

    cached = get_cached_earnings(db_connection, "AAPL")
    assert cached is not None
    assert cached.last_updated == "2025-01-15"
    assert len(cached.annual_eps) == 2
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_db.py::test_save_and_get_earnings -v`
Expected: FAIL with "cannot import name 'save_earnings'"

**Step 3: Update schema in db.py**

Update `SCHEMA` in `src/stock_index_info/db.py`:

```python
SCHEMA = """
CREATE TABLE IF NOT EXISTS constituents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ticker TEXT NOT NULL,
    index_code TEXT NOT NULL CHECK (index_code IN ('sp500', 'nasdaq100')),
    added_date TEXT,
    removed_date TEXT,
    reason TEXT,
    UNIQUE(ticker, index_code, added_date)
);

CREATE INDEX IF NOT EXISTS idx_constituents_ticker ON constituents(ticker);
CREATE INDEX IF NOT EXISTS idx_constituents_index ON constituents(index_code);

CREATE TABLE IF NOT EXISTS earnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ticker TEXT NOT NULL,
    fiscal_year INTEGER NOT NULL,
    eps REAL NOT NULL,
    last_updated TEXT NOT NULL,
    UNIQUE(ticker, fiscal_year)
);

CREATE INDEX IF NOT EXISTS idx_earnings_ticker ON earnings(ticker);
"""
```

**Step 4: Add save_earnings and get_cached_earnings functions**

Add to `src/stock_index_info/db.py`:

```python
from stock_index_info.models import ConstituentRecord, IndexMembership, INDEX_NAMES, EarningsRecord, CachedEarnings
```

Then add functions:

```python
def save_earnings(
    conn: sqlite3.Connection,
    ticker: str,
    records: list[EarningsRecord],
    last_updated: str,
) -> None:
    """Save earnings records for a ticker, replacing any existing data."""
    ticker_upper = ticker.upper()

    # Delete existing data for this ticker
    conn.execute("DELETE FROM earnings WHERE ticker = ?", (ticker_upper,))

    # Insert new records
    for record in records:
        conn.execute(
            """
            INSERT INTO earnings (ticker, fiscal_year, eps, last_updated)
            VALUES (?, ?, ?, ?)
            """,
            (ticker_upper, record.fiscal_year, record.eps, last_updated),
        )
    conn.commit()


def get_cached_earnings(conn: sqlite3.Connection, ticker: str) -> Optional[CachedEarnings]:
    """Get cached earnings for a ticker, or None if not cached."""
    ticker_upper = ticker.upper()

    cursor = conn.execute(
        """
        SELECT fiscal_year, eps, last_updated
        FROM earnings
        WHERE ticker = ?
        ORDER BY fiscal_year DESC
        """,
        (ticker_upper,),
    )

    rows = cursor.fetchall()
    if not rows:
        return None

    records = [
        EarningsRecord(ticker=ticker_upper, fiscal_year=row[0], eps=row[1])
        for row in rows
    ]

    return CachedEarnings(
        ticker=ticker_upper,
        last_updated=rows[0][2],  # All rows have same last_updated
        annual_eps=records,
    )
```

Also add `Optional` import if not already present:

```python
from typing import Optional
```

**Step 5: Run tests to verify they pass**

Run: `uv run pytest tests/test_db.py::test_save_and_get_earnings tests/test_db.py::test_get_cached_earnings_not_found tests/test_db.py::test_save_earnings_replaces_old_data -v`
Expected: PASS

**Step 6: Run all tests and type check**

Run: `uv run pytest -v && uv run mypy src/`
Expected: All tests pass, no type errors

**Step 7: Commit**

```bash
git add src/stock_index_info/db.py tests/test_db.py
git commit -m "feat(db): add earnings cache table and save/get functions"
```

---

## Task 5: Create Alpha Vantage Client Module

**Files:**
- Create: `src/stock_index_info/alpha_vantage.py`
- Create: `tests/test_alpha_vantage.py`

**Step 1: Write the failing test**

Create `tests/test_alpha_vantage.py`:

```python
"""Tests for Alpha Vantage module."""

import pytest


def test_fetch_annual_eps_valid_ticker():
    """Test fetching annual EPS for a valid ticker."""
    from stock_index_info.config import ALPHA_VANTAGE_API_KEY
    from stock_index_info.alpha_vantage import fetch_annual_eps

    if not ALPHA_VANTAGE_API_KEY:
        pytest.skip("ALPHA_VANTAGE_API_KEY not set")

    records = fetch_annual_eps("IBM")

    assert records is not None
    assert len(records) >= 7  # Should have at least 7 years
    assert all(r.ticker == "IBM" for r in records)
    assert all(r.fiscal_year >= 2000 for r in records)
    # Should be sorted by year descending
    years = [r.fiscal_year for r in records]
    assert years == sorted(years, reverse=True)


def test_fetch_annual_eps_invalid_ticker():
    """Test fetching EPS for invalid ticker returns None."""
    from stock_index_info.config import ALPHA_VANTAGE_API_KEY
    from stock_index_info.alpha_vantage import fetch_annual_eps

    if not ALPHA_VANTAGE_API_KEY:
        pytest.skip("ALPHA_VANTAGE_API_KEY not set")

    records = fetch_annual_eps("INVALIDTICKER12345")
    assert records is None


def test_fetch_annual_eps_no_api_key(monkeypatch):
    """Test that fetch returns None when API key not configured."""
    from stock_index_info import config
    from stock_index_info.alpha_vantage import fetch_annual_eps

    monkeypatch.setattr(config, "ALPHA_VANTAGE_API_KEY", None)

    records = fetch_annual_eps("AAPL")
    assert records is None
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_alpha_vantage.py::test_fetch_annual_eps_no_api_key -v`
Expected: FAIL with "No module named 'stock_index_info.alpha_vantage'"

**Step 3: Write implementation**

Create `src/stock_index_info/alpha_vantage.py`:

```python
"""Alpha Vantage API client for fetching earnings data."""

from typing import Optional

from curl_cffi import requests

from stock_index_info.config import ALPHA_VANTAGE_API_KEY
from stock_index_info.models import EarningsRecord


def fetch_annual_eps(ticker: str) -> Optional[list[EarningsRecord]]:
    """Fetch annual EPS data from Alpha Vantage EARNINGS API.

    Args:
        ticker: Stock ticker symbol (e.g., "AAPL")

    Returns:
        List of EarningsRecord sorted by fiscal_year descending,
        or None if API key not configured or ticker not found.
    """
    if not ALPHA_VANTAGE_API_KEY:
        return None

    url = "https://www.alphavantage.co/query"
    params = {
        "function": "EARNINGS",
        "symbol": ticker.upper(),
        "apikey": ALPHA_VANTAGE_API_KEY,
    }

    try:
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        data = response.json()

        # Check for error responses
        if "Error Message" in data or "Note" in data:
            return None

        annual_earnings = data.get("annualEarnings", [])
        if not annual_earnings:
            return None

        records: list[EarningsRecord] = []
        ticker_upper = ticker.upper()

        for entry in annual_earnings:
            fiscal_date = entry.get("fiscalDateEnding", "")
            eps_str = entry.get("reportedEPS", "")

            # Skip entries with missing or invalid data
            if not fiscal_date or not eps_str or eps_str == "None":
                continue

            try:
                fiscal_year = int(fiscal_date[:4])
                eps = float(eps_str)
                records.append(
                    EarningsRecord(ticker=ticker_upper, fiscal_year=fiscal_year, eps=eps)
                )
            except (ValueError, TypeError):
                continue

        if not records:
            return None

        # Sort by fiscal year descending
        records.sort(key=lambda r: r.fiscal_year, reverse=True)
        return records

    except Exception:
        return None
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_alpha_vantage.py::test_fetch_annual_eps_no_api_key -v`
Expected: PASS

**Step 5: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 6: Commit**

```bash
git add src/stock_index_info/alpha_vantage.py tests/test_alpha_vantage.py
git commit -m "feat(alpha_vantage): add fetch_annual_eps function"
```

---

## Task 6: Create Stock Price Fetcher

**Files:**
- Modify: `src/stock_index_info/alpha_vantage.py`
- Modify: `tests/test_alpha_vantage.py`

**Step 1: Write the failing test**

Add to `tests/test_alpha_vantage.py`:

```python
def test_get_current_price_valid_ticker():
    """Test getting current price for a valid ticker."""
    from stock_index_info.alpha_vantage import get_current_price

    price = get_current_price("AAPL")

    assert price is not None
    assert price > 0


def test_get_current_price_invalid_ticker():
    """Test getting price for invalid ticker returns None."""
    from stock_index_info.alpha_vantage import get_current_price

    price = get_current_price("INVALIDTICKER12345")
    assert price is None
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_alpha_vantage.py::test_get_current_price_valid_ticker -v`
Expected: FAIL with "cannot import name 'get_current_price'"

**Step 3: Write implementation**

Add to `src/stock_index_info/alpha_vantage.py`:

```python
import yfinance as yf


def get_current_price(ticker: str) -> Optional[float]:
    """Get current stock price using yfinance.

    Args:
        ticker: Stock ticker symbol (e.g., "AAPL")

    Returns:
        Current price as float, or None if not found.
    """
    try:
        stock = yf.Ticker(ticker.upper())
        # Try fast_info first (faster), fall back to info
        price = stock.fast_info.get("lastPrice")
        if price is None:
            info = stock.info
            price = info.get("currentPrice") or info.get("regularMarketPrice")
        return float(price) if price else None
    except Exception:
        return None
```

**Step 4: Run tests to verify they pass**

Run: `uv run pytest tests/test_alpha_vantage.py::test_get_current_price_valid_ticker tests/test_alpha_vantage.py::test_get_current_price_invalid_ticker -v`
Expected: PASS

**Step 5: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 6: Commit**

```bash
git add src/stock_index_info/alpha_vantage.py tests/test_alpha_vantage.py
git commit -m "feat(alpha_vantage): add get_current_price using yfinance"
```

---

## Task 7: Create 7-Year Average P/E Calculator

**Files:**
- Modify: `src/stock_index_info/alpha_vantage.py`
- Modify: `tests/test_alpha_vantage.py`

**Step 1: Write the failing test**

Add to `tests/test_alpha_vantage.py`:

```python
def test_calculate_7year_avg_pe():
    """Test calculating 7-year average P/E."""
    from stock_index_info.alpha_vantage import calculate_7year_avg_pe
    from stock_index_info.models import EarningsRecord

    records = [
        EarningsRecord(ticker="TEST", fiscal_year=2024, eps=5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2023, eps=4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2022, eps=3.0),
        EarningsRecord(ticker="TEST", fiscal_year=2021, eps=4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2020, eps=5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2019, eps=6.0),
        EarningsRecord(ticker="TEST", fiscal_year=2018, eps=8.0),
    ]
    # Average EPS = (5+4+3+4+5+6+8) / 7 = 35 / 7 = 5.0
    # P/E = 100 / 5.0 = 20.0
    current_price = 100.0

    pe = calculate_7year_avg_pe(records, current_price)

    assert pe is not None
    assert abs(pe - 20.0) < 0.01


def test_calculate_7year_avg_pe_insufficient_data():
    """Test that P/E returns None when less than 7 years of data."""
    from stock_index_info.alpha_vantage import calculate_7year_avg_pe
    from stock_index_info.models import EarningsRecord

    records = [
        EarningsRecord(ticker="TEST", fiscal_year=2024, eps=5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2023, eps=4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2022, eps=3.0),
    ]
    current_price = 100.0

    pe = calculate_7year_avg_pe(records, current_price)

    assert pe is None


def test_calculate_7year_avg_pe_negative_average():
    """Test that P/E returns None when average EPS is negative or zero."""
    from stock_index_info.alpha_vantage import calculate_7year_avg_pe
    from stock_index_info.models import EarningsRecord

    records = [
        EarningsRecord(ticker="TEST", fiscal_year=2024, eps=-5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2023, eps=-4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2022, eps=-3.0),
        EarningsRecord(ticker="TEST", fiscal_year=2021, eps=-4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2020, eps=-5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2019, eps=-6.0),
        EarningsRecord(ticker="TEST", fiscal_year=2018, eps=-8.0),
    ]
    current_price = 100.0

    pe = calculate_7year_avg_pe(records, current_price)

    assert pe is None
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_alpha_vantage.py::test_calculate_7year_avg_pe -v`
Expected: FAIL with "cannot import name 'calculate_7year_avg_pe'"

**Step 3: Write implementation**

Add to `src/stock_index_info/alpha_vantage.py`:

```python
def calculate_7year_avg_pe(
    earnings: list[EarningsRecord],
    current_price: float,
) -> Optional[float]:
    """Calculate P/E ratio using 7-year average EPS.

    Args:
        earnings: List of EarningsRecord, should be sorted by fiscal_year descending
        current_price: Current stock price

    Returns:
        P/E ratio, or None if insufficient data (< 7 years) or avg EPS <= 0
    """
    if len(earnings) < 7:
        return None

    # Take the 7 most recent years
    recent_7 = earnings[:7]
    avg_eps = sum(r.eps for r in recent_7) / 7

    if avg_eps <= 0:
        return None

    return current_price / avg_eps
```

**Step 4: Run tests to verify they pass**

Run: `uv run pytest tests/test_alpha_vantage.py::test_calculate_7year_avg_pe tests/test_alpha_vantage.py::test_calculate_7year_avg_pe_insufficient_data tests/test_alpha_vantage.py::test_calculate_7year_avg_pe_negative_average -v`
Expected: PASS

**Step 5: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 6: Commit**

```bash
git add src/stock_index_info/alpha_vantage.py tests/test_alpha_vantage.py
git commit -m "feat(alpha_vantage): add calculate_7year_avg_pe function"
```

---

## Task 8: Create Get P/E with Cache Logic

**Files:**
- Modify: `src/stock_index_info/alpha_vantage.py`
- Modify: `tests/test_alpha_vantage.py`

**Step 1: Write the failing test**

Add to `tests/test_alpha_vantage.py`:

```python
def test_get_7year_pe_with_cache(db_connection):
    """Test getting 7-year P/E uses cache when available."""
    from stock_index_info.alpha_vantage import get_7year_pe
    from stock_index_info.db import save_earnings
    from stock_index_info.models import EarningsRecord

    # Pre-populate cache with 7 years of data
    records = [
        EarningsRecord(ticker="TEST", fiscal_year=2024, eps=5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2023, eps=4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2022, eps=3.0),
        EarningsRecord(ticker="TEST", fiscal_year=2021, eps=4.0),
        EarningsRecord(ticker="TEST", fiscal_year=2020, eps=5.0),
        EarningsRecord(ticker="TEST", fiscal_year=2019, eps=6.0),
        EarningsRecord(ticker="TEST", fiscal_year=2018, eps=8.0),
    ]
    save_earnings(db_connection, "TEST", records, "2025-01-15")

    # Mock current price
    result = get_7year_pe(db_connection, "TEST", current_price=100.0)

    assert result is not None
    assert abs(result - 20.0) < 0.01
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_alpha_vantage.py::test_get_7year_pe_with_cache -v`
Expected: FAIL with "cannot import name 'get_7year_pe'"

**Step 3: Write implementation**

Add to `src/stock_index_info/alpha_vantage.py`:

```python
import sqlite3
from datetime import date

from stock_index_info.db import get_cached_earnings, save_earnings


def get_7year_pe(
    conn: sqlite3.Connection,
    ticker: str,
    current_price: Optional[float] = None,
    latest_filing_date: Optional[str] = None,
) -> Optional[float]:
    """Get 7-year average P/E ratio for a ticker.

    Uses cached EPS data if available and not stale. Fetches from Alpha Vantage
    if cache is empty or if latest_filing_date is newer than cache.

    Args:
        conn: Database connection
        ticker: Stock ticker symbol
        current_price: Current stock price (fetched via yfinance if not provided)
        latest_filing_date: Latest SEC filing date (ISO format). If newer than
                           cache last_updated, triggers cache refresh.

    Returns:
        7-year average P/E ratio, or None if insufficient data.
    """
    ticker_upper = ticker.upper()

    # Get cached data
    cached = get_cached_earnings(conn, ticker_upper)

    # Determine if we need to refresh cache
    need_refresh = False
    if cached is None:
        need_refresh = True
    elif latest_filing_date and latest_filing_date > cached.last_updated:
        need_refresh = True

    # Refresh cache if needed
    if need_refresh:
        new_records = fetch_annual_eps(ticker_upper)
        if new_records:
            today = date.today().isoformat()
            save_earnings(conn, ticker_upper, new_records, today)
            cached = get_cached_earnings(conn, ticker_upper)

    # Check if we have enough data
    if cached is None or len(cached.annual_eps) < 7:
        return None

    # Get current price if not provided
    if current_price is None:
        current_price = get_current_price(ticker_upper)
        if current_price is None:
            return None

    return calculate_7year_avg_pe(cached.annual_eps, current_price)
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_alpha_vantage.py::test_get_7year_pe_with_cache -v`
Expected: PASS

**Step 5: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 6: Commit**

```bash
git add src/stock_index_info/alpha_vantage.py tests/test_alpha_vantage.py
git commit -m "feat(alpha_vantage): add get_7year_pe with cache logic"
```

---

## Task 9: Integrate P/E into Bot Query Response

**Files:**
- Modify: `src/stock_index_info/bot.py:230-295`

**Step 1: Update imports in bot.py**

Add import at top of `src/stock_index_info/bot.py`:

```python
from stock_index_info.alpha_vantage import get_7year_pe
```

**Step 2: Modify _query_ticker function**

Update `_query_ticker` function in `src/stock_index_info/bot.py` to add P/E at the top of results. Replace the function body starting from line 230:

```python
async def _query_ticker(update: Update, ticker: str) -> None:
    """Query and respond with ticker information."""
    if not update.message:
        return

    # Ensure data directory exists
    DB_PATH.parent.mkdir(parents=True, exist_ok=True)

    if not DB_PATH.exists():
        await update.message.reply_text(
            "Database not initialized. Please run /sync first or wait for auto-sync."
        )
        return

    conn = init_db(DB_PATH)
    try:
        memberships = get_stock_memberships(conn, ticker)

        # Build response
        lines: list[str] = [f"*{ticker}*", ""]

        # Fetch SEC filings first (needed for cache invalidation check)
        filings = get_recent_filings(ticker)

        # Get latest filing date for cache invalidation
        latest_filing_date: Optional[str] = None
        if filings:
            all_dates: list[str] = [q.filing_date for q in filings.quarterly]
            if filings.annual:
                all_dates.append(filings.annual.filing_date)
            if all_dates:
                latest_filing_date = max(all_dates)

        # Calculate and display 7-year average P/E (at the top)
        pe = get_7year_pe(conn, ticker, latest_filing_date=latest_filing_date)
        if pe is not None:
            lines.append(f"P/E (7Y Avg): {pe:.1f}")
            lines.append("")

        if memberships:
            lines.append("Index Membership:")
            lines.append("```")
            lines.append(f"{'Index':<12} {'Added':<12} {'Removed':<12} {'Years':>6}")
            lines.append("-" * 44)

            for m in memberships:
                added_str = m.added_date.isoformat() if m.added_date else "?"
                removed_str = m.removed_date.isoformat() if m.removed_date else "-"
                years_str = (
                    f"{m.years_in_index:>6.1f}" if m.years_in_index is not None else "     ?"
                )
                lines.append(f"{m.index_name:<12} {added_str:<12} {removed_str:<12} {years_str}")

            lines.append("```")
        else:
            lines.append("Not found in any tracked index.")

        # Display SEC filings
        if filings and (filings.quarterly or filings.annual):
            lines.append("")
            lines.append("SEC Filings:")

            # Show quarterly reports (10-Q)
            if filings.quarterly:
                lines.append("Quarterly (10-Q):")
                for q in filings.quarterly:
                    lines.append(f"  {q.filing_date}: {q.filing_url}")

            # Show annual report (10-K)
            if filings.annual:
                lines.append("Annual (10-K):")
                lines.append(f"  {filings.annual.filing_date}: {filings.annual.filing_url}")

        # Reuters Valuation link
        lines.append("")
        lines.append(_build_reuters_valuation_links(ticker))

        await update.message.reply_text("\n".join(lines), parse_mode="Markdown")
    except Exception as e:
        logger.error(f"Error querying ticker {ticker}: {e}")
        await update.message.reply_text(f"Error querying {ticker}. Please try again.")
    finally:
        conn.close()
```

Also add `Optional` to typing imports if not already present:

```python
from typing import Callable, Coroutine, Any, Optional
```

**Step 3: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 4: Run lint check**

Run: `uv run ruff check src/ tests/`
Expected: No lint errors

**Step 5: Commit**

```bash
git add src/stock_index_info/bot.py
git commit -m "feat(bot): display 7-year average P/E at top of query results"
```

---

## Task 10: Update Documentation

**Files:**
- Modify: `CODEBUDDY.md`

**Step 1: Update environment variables table**

Add the new environment variable to the table in `CODEBUDDY.md`:

```markdown
## 环境变量

| 变量 | 必填 | 说明 |
|------|------|------|
| `TELEGRAM_BOT_TOKEN` | 是 | BotFather 提供的 bot token |
| `ALLOWED_USER_IDS` | 是 | 允许使用的 Telegram 用户 ID (逗号分隔) |
| `SYNC_HOUR` | 否 | 每日同步时间 (0-23, 默认 2) |
| `SYNC_MINUTE` | 否 | 每日同步分钟 (0-59, 默认 0) |
| `ALPHA_VANTAGE_API_KEY` | 否 | Alpha Vantage API key (7年平均P/E功能需要) |
```

**Step 2: Update database schema section**

Add the earnings table to the database schema section:

```markdown
### 数据库 Schema

```sql
CREATE TABLE constituents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ticker TEXT NOT NULL,
    index_code TEXT NOT NULL CHECK (index_code IN ('sp500', 'nasdaq100')),
    added_date TEXT NOT NULL,
    removed_date TEXT,
    reason TEXT,
    UNIQUE(ticker, index_code, added_date)
);

CREATE TABLE earnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ticker TEXT NOT NULL,
    fiscal_year INTEGER NOT NULL,
    eps REAL NOT NULL,
    last_updated TEXT NOT NULL,
    UNIQUE(ticker, fiscal_year)
);
```
```

**Step 3: Update core modules description**

Add alpha_vantage.py to the core modules list:

```markdown
- **alpha_vantage.py**: Alpha Vantage API 客户端，获取历史年度 EPS 数据；使用 yfinance 获取当前股价；计算7年平均市盈率
```

**Step 4: Commit**

```bash
git add CODEBUDDY.md
git commit -m "docs: update CODEBUDDY.md with earnings cache and P/E feature"
```

---

## Task 11: Final Verification

**Step 1: Run all tests**

Run: `uv run pytest -v`
Expected: All tests pass

**Step 2: Run type check**

Run: `uv run mypy src/`
Expected: No type errors

**Step 3: Run lint check**

Run: `uv run ruff check src/ tests/`
Expected: No lint errors

**Step 4: Manual test (optional)**

If you have an Alpha Vantage API key, test the bot:

```bash
TELEGRAM_BOT_TOKEN=<token> ALLOWED_USER_IDS=<id> ALPHA_VANTAGE_API_KEY=<key> uv run stock-index-bot
```

Query a ticker like `AAPL` and verify the 7-year average P/E appears at the top of the response.
