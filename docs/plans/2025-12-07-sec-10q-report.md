# SEC 10-Q Report Link Feature Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Extend `/query` command to include SEC EDGAR 10-Q quarterly report links for queried stocks.

**Architecture:** Create a new `sec_edgar.py` module that queries SEC EDGAR API to fetch the latest 10-Q filing URL for a given ticker. Integrate this into the existing `_query_ticker()` function in `bot.py`.

**Tech Stack:** `curl_cffi` (already in deps), SEC EDGAR REST API (no auth required)

---

## Task 1: Create SEC EDGAR Data Model

**Files:**
- Modify: `src/stock_index_info/models.py`
- Test: `tests/test_models.py`

**Step 1: Write the failing test**

Add to `tests/test_models.py`:

```python
def test_sec_filing_record_creation():
    """Test SECFilingRecord dataclass creation."""
    from stock_index_info.models import SECFilingRecord

    record = SECFilingRecord(
        ticker="AAPL",
        form_type="10-Q",
        filing_date="2024-11-01",
        filing_url="https://www.sec.gov/Archives/edgar/data/320193/000032019324000123/aapl-20240928.htm",
    )
    assert record.ticker == "AAPL"
    assert record.form_type == "10-Q"
    assert record.filing_date == "2024-11-01"
    assert record.filing_url.startswith("https://www.sec.gov")
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_models.py::test_sec_filing_record_creation -v`
Expected: FAIL with "cannot import name 'SECFilingRecord'"

**Step 3: Write minimal implementation**

Add to `src/stock_index_info/models.py`:

```python
@dataclass
class SECFilingRecord:
    """A record of SEC filing for a stock."""

    ticker: str
    form_type: str
    filing_date: str
    filing_url: str
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_models.py::test_sec_filing_record_creation -v`
Expected: PASS

**Step 5: Run code quality checks**

Run: `uv run ruff check src/ tests/ && uv run mypy src/`
Expected: No errors

**Step 6: Commit**

```bash
git add src/stock_index_info/models.py tests/test_models.py
git commit -m "feat(models): add SECFilingRecord dataclass for SEC filings"
```

---

## Task 2: Create SEC EDGAR Module - Ticker to CIK Mapping

**Files:**
- Create: `src/stock_index_info/sec_edgar.py`
- Create: `tests/test_sec_edgar.py`

**Step 1: Write the failing test**

Create `tests/test_sec_edgar.py`:

```python
"""Tests for SEC EDGAR module."""

import pytest


def test_get_cik_from_ticker_valid():
    """Test getting CIK for a valid ticker."""
    from stock_index_info.sec_edgar import get_cik_from_ticker

    # AAPL's CIK is 320193
    cik = get_cik_from_ticker("AAPL")
    assert cik == "320193"


def test_get_cik_from_ticker_invalid():
    """Test getting CIK for an invalid ticker returns None."""
    from stock_index_info.sec_edgar import get_cik_from_ticker

    cik = get_cik_from_ticker("INVALIDTICKER123")
    assert cik is None


def test_get_cik_from_ticker_case_insensitive():
    """Test that ticker lookup is case insensitive."""
    from stock_index_info.sec_edgar import get_cik_from_ticker

    cik_upper = get_cik_from_ticker("AAPL")
    cik_lower = get_cik_from_ticker("aapl")
    assert cik_upper == cik_lower
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_sec_edgar.py::test_get_cik_from_ticker_valid -v`
Expected: FAIL with "No module named 'stock_index_info.sec_edgar'"

**Step 3: Write minimal implementation**

Create `src/stock_index_info/sec_edgar.py`:

```python
"""SEC EDGAR API client for fetching company filings."""

from typing import Optional

from curl_cffi import requests


# SEC requires a User-Agent header with contact info
SEC_USER_AGENT = "StockIndexInfoBot contact@example.com"


def get_cik_from_ticker(ticker: str) -> Optional[str]:
    """Get CIK (Central Index Key) from ticker symbol.

    Args:
        ticker: Stock ticker symbol (e.g., "AAPL")

    Returns:
        CIK as string without leading zeros, or None if not found
    """
    url = "https://www.sec.gov/files/company_tickers.json"

    try:
        response = requests.get(
            url,
            headers={"User-Agent": SEC_USER_AGENT},
            timeout=30,
        )
        response.raise_for_status()
        data = response.json()

        # Data format: {"0": {"cik_str": 320193, "ticker": "AAPL", "title": "Apple Inc."}, ...}
        ticker_upper = ticker.upper()
        for entry in data.values():
            if entry.get("ticker") == ticker_upper:
                return str(entry["cik_str"])

        return None
    except Exception:
        return None
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_sec_edgar.py -v`
Expected: PASS (note: this makes real HTTP calls)

**Step 5: Run code quality checks**

Run: `uv run ruff check src/ tests/ && uv run mypy src/`
Expected: No errors

**Step 6: Commit**

```bash
git add src/stock_index_info/sec_edgar.py tests/test_sec_edgar.py
git commit -m "feat(sec_edgar): add ticker to CIK mapping function"
```

---

## Task 3: Add 10-Q Filing Lookup Function

**Files:**
- Modify: `src/stock_index_info/sec_edgar.py`
- Modify: `tests/test_sec_edgar.py`

**Step 1: Write the failing test**

Add to `tests/test_sec_edgar.py`:

```python
def test_get_latest_10q_valid_ticker():
    """Test getting latest 10-Q for a valid ticker."""
    from stock_index_info.sec_edgar import get_latest_10q
    from stock_index_info.models import SECFilingRecord

    result = get_latest_10q("AAPL")

    assert result is not None
    assert isinstance(result, SECFilingRecord)
    assert result.ticker == "AAPL"
    assert result.form_type == "10-Q"
    assert result.filing_url.startswith("https://www.sec.gov")
    assert len(result.filing_date) == 10  # YYYY-MM-DD format


def test_get_latest_10q_invalid_ticker():
    """Test getting 10-Q for invalid ticker returns None."""
    from stock_index_info.sec_edgar import get_latest_10q

    result = get_latest_10q("INVALIDTICKER123")
    assert result is None
```

**Step 2: Run test to verify it fails**

Run: `uv run pytest tests/test_sec_edgar.py::test_get_latest_10q_valid_ticker -v`
Expected: FAIL with "cannot import name 'get_latest_10q'"

**Step 3: Write minimal implementation**

Add to `src/stock_index_info/sec_edgar.py`:

```python
from stock_index_info.models import SECFilingRecord


def get_latest_10q(ticker: str) -> Optional[SECFilingRecord]:
    """Get the latest 10-Q filing for a stock.

    Args:
        ticker: Stock ticker symbol (e.g., "AAPL")

    Returns:
        SECFilingRecord with filing details, or None if not found
    """
    cik = get_cik_from_ticker(ticker)
    if cik is None:
        return None

    # Pad CIK to 10 digits for API
    cik_padded = cik.zfill(10)

    # Query company submissions endpoint
    url = f"https://data.sec.gov/submissions/CIK{cik_padded}.json"

    try:
        response = requests.get(
            url,
            headers={"User-Agent": SEC_USER_AGENT},
            timeout=30,
        )
        response.raise_for_status()
        data = response.json()

        # Find latest 10-Q in recent filings
        recent_filings = data.get("filings", {}).get("recent", {})
        forms = recent_filings.get("form", [])
        accession_numbers = recent_filings.get("accessionNumber", [])
        filing_dates = recent_filings.get("filingDate", [])
        primary_documents = recent_filings.get("primaryDocument", [])

        for i, form in enumerate(forms):
            if form == "10-Q":
                accession = accession_numbers[i].replace("-", "")
                filing_date = filing_dates[i]
                primary_doc = primary_documents[i]

                filing_url = (
                    f"https://www.sec.gov/Archives/edgar/data/{cik}/{accession}/{primary_doc}"
                )

                return SECFilingRecord(
                    ticker=ticker.upper(),
                    form_type="10-Q",
                    filing_date=filing_date,
                    filing_url=filing_url,
                )

        return None
    except Exception:
        return None
```

**Step 4: Run test to verify it passes**

Run: `uv run pytest tests/test_sec_edgar.py -v`
Expected: PASS

**Step 5: Run code quality checks**

Run: `uv run ruff check src/ tests/ && uv run mypy src/`
Expected: No errors

**Step 6: Commit**

```bash
git add src/stock_index_info/sec_edgar.py tests/test_sec_edgar.py
git commit -m "feat(sec_edgar): add get_latest_10q function for SEC 10-Q lookup"
```

---

## Task 4: Integrate SEC 10-Q into Bot Query Response

**Files:**
- Modify: `src/stock_index_info/bot.py`

**Step 1: Add import**

Add to imports at top of `src/stock_index_info/bot.py`:

```python
from stock_index_info.sec_edgar import get_latest_10q
```

**Step 2: Modify `_query_ticker` function**

Replace the `_query_ticker` function in `src/stock_index_info/bot.py`:

```python
async def _query_ticker(update: Update, ticker: str) -> None:
    """Query and respond with ticker information."""
    if not update.message:
        return

    # Ensure data directory exists
    DB_PATH.parent.mkdir(parents=True, exist_ok=True)

    if not DB_PATH.exists():
        await update.message.reply_text(
            "Database not initialized. Please run /sync first or wait for auto-sync."
        )
        return

    conn = init_db(DB_PATH)
    try:
        memberships = get_stock_memberships(conn, ticker)

        # Build response
        lines: list[str] = [f"*{ticker}*", ""]

        if memberships:
            lines.append("Index Membership:")
            lines.append("```")
            lines.append(f"{'Index':<12} {'Added':<12} {'Removed':<12} {'Years':>6}")
            lines.append("-" * 44)

            for m in memberships:
                added_str = m.added_date.isoformat() if m.added_date else "?"
                removed_str = m.removed_date.isoformat() if m.removed_date else "-"
                years_str = f"{m.years_in_index:>6.1f}" if m.years_in_index is not None else "     ?"
                lines.append(f"{m.index_name:<12} {added_str:<12} {removed_str:<12} {years_str}")

            lines.append("```")
        else:
            lines.append("Not found in any tracked index.")

        # Fetch SEC 10-Q report
        lines.append("")
        sec_filing = get_latest_10q(ticker)
        if sec_filing:
            lines.append(f"Latest 10-Q ({sec_filing.filing_date}):")
            lines.append(sec_filing.filing_url)
        else:
            lines.append("10-Q Report: Not found")

        await update.message.reply_text("\n".join(lines), parse_mode="Markdown")
    except Exception as e:
        logger.error(f"Error querying ticker {ticker}: {e}")
        await update.message.reply_text(f"Error querying {ticker}. Please try again.")
    finally:
        conn.close()
```

**Step 3: Run code quality checks**

Run: `uv run ruff check src/ tests/ && uv run mypy src/`
Expected: No errors

**Step 4: Commit**

```bash
git add src/stock_index_info/bot.py
git commit -m "feat(bot): integrate SEC 10-Q report link into query response"
```

---

## Task 5: Manual Integration Test

**Step 1: Run the bot locally**

```bash
TELEGRAM_BOT_TOKEN=<your-token> ALLOWED_USER_IDS=<your-id> uv run stock-index-bot
```

**Step 2: Test via Telegram**

Send `/query AAPL` to your bot and verify:
1. Index membership info displays correctly
2. Latest 10-Q link appears with filing date
3. Link is clickable and leads to SEC EDGAR

**Step 3: Test edge cases**

- `/query INVALIDTICKER` - should show "Not found in any tracked index" and "10-Q Report: Not found"
- `/query BRK.A` - Berkshire Hathaway (has special ticker format)
- Direct message `MSFT` - should also show 10-Q link

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Add SECFilingRecord model | models.py, test_models.py |
| 2 | CIK lookup function | sec_edgar.py, test_sec_edgar.py |
| 3 | 10-Q filing lookup | sec_edgar.py, test_sec_edgar.py |
| 4 | Bot integration | bot.py |
| 5 | Manual testing | - |

**Total estimated time:** 30-45 minutes
